version: "2"

run:
  timeout: 5m

linters:
  # ============================================================================
  # Disabled linters (with reasons)
  # ============================================================================
  # - cyclop            # complexity: too noisy, flags test helpers
  # - exhaustruct       # zero values are idiomatic in Go
  # - funlen            # complexity: too noisy, flags test helpers
  # - gochecknoglobals  # registries, version info, etc.
  # - gocognit          # complexity: too noisy, flags test helpers
  # - gocyclo           # complexity: same as cyclop, pick one
  # - goheader          # no copyright headers needed
  # - lll               # line length: too noisy
  # - maintidx          # complexity: too noisy
  # - mnd               # magic numbers: too noisy, forces useless constants
  # - nestif            # complexity: too noisy
  # - err113            # forces sentinel errors for all dynamic errors; not all
  #                     # errors are API - some are just descriptive messages for
  #                     # programming bugs or internal invariant violations that
  #                     # callers should never errors.Is() check
  # - varnamelen        # styling: LLMs like short vars

  # ============================================================================
  # Enabled linters
  # ============================================================================
  enable:
    - asasalint
    - asciicheck
    - bidichk
    - bodyclose
    - canonicalheader
    - containedctx
    - contextcheck
    - copyloopvar
    - decorder
    - depguard
    - dogsled
    - dupl
    - dupword
    - durationcheck
    - embeddedstructfieldcheck
    - errcheck
    - errchkjson
    - errname
    - errorlint
    - exhaustive
    - exptostd
    - fatcontext
    - forbidigo
    - forcetypeassert
    - funcorder
    - gocheckcompilerdirectives
    - gochecknoinits
    - gochecksumtype
    - goconst
    - gocritic
    - godoclint
    - godot
    - godox
    - gomoddirectives
    - gomodguard
    - goprintffuncname
    - gosec
    - gosmopolitan
    - govet
    - grouper
    - iface
    - importas
    - inamedparam
    - ineffassign
    - interfacebloat
    - intrange
    - iotamixing
    - ireturn
    - loggercheck
    - makezero
    - mirror
    - misspell
    - modernize
    - musttag
    - nakedret
    - nilerr
    - nilnesserr
    - nilnil
    - nlreturn
    - noctx
    - noinlineerr
    - nolintlint
    - nonamedreturns
    - nosprintfhostport
    - paralleltest
    - perfsprint
    - prealloc
    - predeclared
    - promlinter
    - protogetter
    - reassign
    - recvcheck
    - revive
    - rowserrcheck
    - sloglint
    - spancheck
    - sqlclosecheck
    - staticcheck
    - tagalign
    - tagliatelle
    - testableexamples
    - testifylint
    - testpackage
    - thelper
    - tparallel
    - unconvert
    - unparam
    - unqueryvet
    - unused
    - usestdlibvars
    - usetesting
    - wastedassign
    - whitespace
    - wrapcheck
    - wsl_v5
    - zerologlint
  settings:
    errcheck:
      check-type-assertions: true
      # check-blank: true  # _ = fn() is intentional "I know, ignoring it" - forcing
      #                    # if err := fn(); err != nil { /* ignore */ } is just boilerplate
      exclude-functions:
        - fmt.Fprintf
        - fmt.Fprintln
        - fmt.Fprint
        # pflag.Get* can't fail if the flag was defined
        - (*github.com/spf13/pflag.FlagSet).GetBool
        - (*github.com/spf13/pflag.FlagSet).GetString
        - (*github.com/spf13/pflag.FlagSet).GetStringArray
        # best-effort directory enumeration
        - path/filepath.WalkDir
        # can't error when path is under base (only errors if no common base)
        - path/filepath.Rel
    govet:
      enable-all: true
      disable:
        - fieldalignment # micro-optimization, too noisy
    staticcheck:
      checks: ["all"]
    nolintlint:
      require-explanation: true
      require-specific: true
    testifylint:
      enable-all: true
    unparam:
      check-exported: true
    prealloc:
      for-loops: true
    copyloopvar:
      check-alias: true
    exhaustive:
      default-signifies-exhaustive: true
    fatcontext:
      check-struct-pointers: true
    goconst:
      numbers: true
      find-duplicates: true
    usestdlibvars:
      time-month: true
      time-layout: true
      crypto-hash: true
    usetesting:
      os-temp-dir: true
      context-background: true
      context-todo: true
    perfsprint:
      err-error: true
    predeclared:
      qualified-name: true
    unconvert:
      fast-math: true
      safe: true
    wrapcheck: {}
    sloglint:
      static-msg: true
      no-raw-keys: true
    tagalign:
      strict: true
    makezero:
      always: false # only warn on make([]T, n) + append (the real bug), not indexed assignment
    nilnil:
      detect-opposite: true
    ineffassign:
      check-escaping-errors: true
    loggercheck:
      require-string-key: true
      no-printf-like: true

    nakedret:
      max-func-lines: 0
    gocritic:
      enable-all: true
      disabled-checks:
        - paramTypeCombine # style preference
        - unnamedResult # style preference
    revive:
      enable-all-rules: true
      rules:
        - name: line-length-limit
          disabled: true # use lll instead (configured at 200)
        - name: function-length
          disabled: true # duplicates funlen (disabled globally)
        - name: add-constant
          disabled: true # duplicates mnd (disabled globally)
        - name: cognitive-complexity
          disabled: true # duplicates gocognit (disabled globally)
        - name: cyclomatic
          disabled: true # duplicates cyclop (disabled globally)
        - name: unhandled-error
          disabled: true # duplicates errcheck
        - name: confusing-results
          disabled: true # duplicates unnamedResult in gocritic
        - name: flag-parameter
          disabled: true # too strict, flags are fine for internal funcs
        - name: max-public-structs
          disabled: true # too strict, domain packages often need multiple exported types
        - name: redundant-test-main-exit
          disabled: true # false positive: os.Exit(m.Run()) is required pattern
        - name: enforce-switch-style
          disabled: true # too strict for exhaustive switches

    depguard:
      rules:
        main:
          deny:
            - pkg: "io/ioutil"
              desc: "deprecated since Go 1.16, use io and os packages"
            - pkg: "log"
              desc: "use log/slog for structured logging"
            - pkg: "github.com/pkg/errors"
              desc: "deprecated, use stdlib errors with fmt.Errorf %w"
            - pkg: "math/rand"
              desc: "use crypto/rand or math/rand/v2"
    tagliatelle:
      case:
        rules:
          json: snake
          yaml: snake
          toml: snake
          env: upperSnake
    gosec:
      excludes:
        - G304 # file inclusion via variable - we use paths from ReadDir
    forbidigo:
      analyze-types: true
      forbid:
        - pattern: '^time\.Sleep$'
          msg: "time.Sleep is flaky in tests (use testing/synctest) and usually wrong in production (use tickers, timers, or context)."
        - pattern: '^os\.Getenv$'
          msg: "os.Getenv bypasses env abstraction - use the env map passed to Run() instead."
        - pattern: '^os\.LookupEnv$'
          msg: "os.LookupEnv bypasses env abstraction - use the env map passed to Run() instead."
        - pattern: '^os\.ExpandEnv$'
          msg: "os.ExpandEnv bypasses env abstraction - use the env map passed to Run() instead."
  exclusions:
    rules:
      - path: _test\.go
        linters:
          - dupl
          - noctx
          - errcheck # allow _ = err in tests
          - wrapcheck # test code doesn't need to wrap errors from packages under test
          - gosec # G104 duplicates errcheck
      # Allow time.Sleep in tests
      - path: _test\.go
        text: "time\\.Sleep"
        linters:
          - forbidigo
      # Allow time.Sleep in readBackoff (hot path optimization - avoids timer allocation)
      - path: pkg/slotcache/slotcache\.go
        text: "time\\.Sleep"
        linters:
          - forbidigo
      # Allow env access in tests
      - path: _test\.go
        text: "os\\.(Getenv|LookupEnv|ExpandEnv)"
        linters:
          - forbidigo
      - path: _test\.go
        text: "G204:" # subprocess launched with variable
        linters:
          - gosec
      - path: _test\.go
        text: "G302:" # directory permissions for test cleanup
        linters:
          - gosec
      - path: _test\.go
        text: "G306:" # file permissions > 0600
        linters:
          - gosec
      - path: main\.go
        text: "G204:"
        linters:
          - gosec
      # Atomic operations on mmap'd memory require unsafe - this is intentional
      # and necessary for cross-process seqlock correctness per spec.
      - path: pkg/slotcache/format\.go
        text: "G103:"
        linters:
          - gosec
      - path: sandbox\.go
        text: "G204:" # sandbox executes bwrap by design
        linters:
          - gosec
      # rand.Read requires pre-sized slice
      - path: cmd_exec\.go
        text: "slice .* does not have non-zero initial length"
        linters:
          - makezero
      # Allow math/rand/v2 for deterministic seeded testing in chaos/crash FS
      - path: pkg/fs/(chaos|crash).*\.go
        text: "math/rand"
        linters:
          - depguard
      # Chaos/crash FS uses unsafe patterns intentionally (weak RNG, perms, etc.)
      - path: pkg/fs/(chaos|crash).*\.go
        linters:
          - gosec
      - path: pkg/fs/fs\.go
        linters:
          - interfacebloat
      - path: pkg/fs/lock_test\.go
        linters:
          - testpackage
      # These files are passthrough wrappers - wrapping errors would obscure the source
      - path: pkg/fs/(chaos|crash|crash_file|real)\.go
        linters:
          - wrapcheck
      # FS abstraction requires returning File interface
      - path: pkg/fs/
        linters:
          - ireturn
      # Test harness returns polymorphic Operation/OperationResult types
      - path: pkg/slotcache/internal/testutil/
        linters:
          - ireturn
      # Cache API returns interfaces by design (Cache, Writer)
      - path: pkg/slotcache/slotcache\.go
        linters:
          - ireturn
          # Harness compares model vs real errors directly; wrapping would obscure mismatches
          - wrapcheck
          # Model methods match real interface signatures but some never fail
          - unparam
      # White-box test for internal format functions
      - path: pkg/slotcache/format_test\.go
        linters:
          - testpackage
      # Allow math/rand/v2 for deterministic seeded testing in slotcache
      - path: pkg/slotcache/behavior_.*_test\.go
        text: "math/rand"
        linters:
          - depguard

      # Test Op factory returns interface by design
      - path: fuzz_model_test\.go
        linters:
          - ireturn
      # Allow math/rand/v2 for fuzz testing
      - path: internal/cli/fuzz.*\.go
        text: "math/rand"
        linters:
          - depguard
      # terminateCrash intentionally calls os.Exit to simulate process crashes
      - path: pkg/fs/crash_panic\.go
        text: "deep-exit"
        linters:
          - revive
      # Core domain types require multiple public structs
      - path: (internal/spec/spec\.go|pkg/fs/chaos\.go|internal/cli/fuzz_model_test\.go)
        text: "max-public-structs"
        linters:
          - revive

formatters:
  enable:
    - gofmt
    - goimports
  settings:
    goimports:
      local-prefixes:
        - github.com/calvinalkan/agent-task
